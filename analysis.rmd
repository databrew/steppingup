---
title: "osduhs"
author: "Ben Brew"
date: "December 21, 2017"
output: html_document
---

```{r, echo = FALSE, warning = FALSE, message = FALSE, comment = NA, error= FALSE}

library(tidyverse)
library(glmnet)
library(broom)

# source
# source('global.R')
source('functions.R')
# load global to get survey data
load('data/processed_survey_data.RData')

# extract the "2015_ontario_student_drug_use_and_health_survey" (10th element in list)
dat <- survey[[10]]

# convert date to date object 
dat$demo_osduhs_date <- get_date_osduhs(dat$demo_osduhs_date)

# recode dat$hw_osduhs_used_cannabis_past_12_months.1
colnames(dat) <- ifelse(grepl('months.1', colnames(dat), fixed = TRUE), 'hw_osduhs_used_cannabis_ever', colnames(dat))

# recode dat$demo_osduhs_sex_male
colnames(dat) <- ifelse(grepl('demo_osduhs_sex_male', colnames(dat), fixed = TRUE), 'demo_osduhs_sex', colnames(dat))

# recode hw_osduhs_drank_alcohol_past_12_months
dat$hw_osduhs_drank_alcohol_past_12_months <- as.factor(ifelse(grepl('no',dat$hw_osduhs_drank_alcohol_past_12_months), 
                                                     'no', ifelse(grepl('yes', dat$hw_osduhs_drank_alcohol_past_12_months), 'yes', dat$hw_osduhs_drank_alcohol_past_12_months)))

# recode used_cannabis_ever
dat$hw_osduhs_used_cannabis_ever <- as.factor(ifelse(grepl('never', dat$hw_osduhs_used_cannabis_ever), 
                                                     'no', ifelse(grepl('lifetime', dat$hw_osduhs_used_cannabis_ever), 'yes', dat$hw_osduhs_used_cannabis_ever)))

# remove ids 
dat$hw_osduhs_ids <- dat$hw_osduhs_ids.1 <- dat$demo_osduhs_date <- dat$demo_osduhs_sex_female <-  NULL

```

```{r, echo = FALSE, warning = FALSE, message = FALSE, comment = NA, error= FALSE}
# function that takes an column and groups by to get sums and percentages
model_data <- dat

weights <- NULL

get_glm <- function(model_data = dat, weights = FALSE) {

  # remove NAS
  model_data <- as.data.frame(model_data[complete.cases(model_data),])
    
  # loop through variables (exlude demo and a few others) and estimate logit with every other relevant variable
  # start at 8, becayse the first 7 are more demographic
  for(i in 8:colnames(model_data)){
    # remove variables that cannot be modeled
    y_outcome <- model_data[,i]
    # loop though colnames (without demo) and estimate logit
    logit_mod <- glm(y_outcome~. , family = 'binomial', weights = weights, data = model_data)
    model_result <- cbind(tidy(logit_mod), odds_ratio = tidy(exp(coef(logit_mod))))
    model_result$odds_ratio.names <- NULL
  
  }

}

function(y, x, dataset, weights){
  f <- substitute(glm(y~x, data=dataset, weights=weights, family=binomial))
  logLik(eval(f))
}

```


```{r, echo = FALSE, warning = FALSE, message = FALSE, comment = NA, error= FALSE}
# function that takes an column and groups by to get sums and percentages 
get_variable_groups <- function(column_name) {
  
}

```
